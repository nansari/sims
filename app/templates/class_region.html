<!--
This template is used for the Class Region page. It allows users to create new
class regions by filling out a form. The form includes dropdowns for class name
and class batch, where the class batch dropdown is dynamically populated based
on the selected class name using JavaScript.

The template also displays a list of existing class regions.
-->
{% extends "base.html" %}

{% block content %}
    <h1>Class Region</h1>
    <form action="" method="post" novalidate>
        {{ form.hidden_tag() }}
        <p>
            {{ form.class_name_id.label }}<br>
            {{ form.class_name_id() }}
            {% for error in form.class_name_id.errors %}
            <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </p>
        <p>
            {{ form.class_batch_id.label }}<br>
            {{ form.class_batch_id() }}
            {% for error in form.class_batch_id.errors %}
            <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </p>
        <p>
            {{ form.section.label }}<br>
            {{ form.section(size=1) }}
            {% for error in form.section.errors %}
            <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </p>
        <p>
            {{ form.description.label }}<br>
            {{ form.description(size=255) }}
            {% for error in form.description.errors %}
            <span style="color: red;">[{{ error }}]</span>
            {% endfor %}
        </p>
        <p>{{ form.submit() }}</p>
    </form>
    <hr>
    <form action="" method="get">
        <input type="text" name="search" placeholder="Search by section" value="{{ request.args.get('search', '') }}">
        <input type="submit" value="Search">
    </form>
    <hr>
    <h2>Existing Class Regions</h2>
    <ul>
        {% for region in regions %}
        <li>{{ region.class_name.name }} - {{ region.class_batch.batch_no }} - {{ region.section }}</li>
        {% endfor %}
    </ul>
{% endblock %}

{% block custom_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const classNameSelect = document.getElementById('class_name_id');
        const classBatchSelect = document.getElementById('class_batch_id');

        function updateBatches() {
            const classNameId = classNameSelect.value;
            classBatchSelect.innerHTML = '<option value="">Loading...</option>';

            if (classNameId) {
                fetch(`/api/class_batches/${classNameId}`)
                    .then(response => response.json())
                    .then(data => {
                        classBatchSelect.innerHTML = '<option value="">Select a Batch</option>';
                        data.forEach(batch => {
                            const option = document.createElement('option');
                            option.value = batch.id;
                            option.textContent = batch.name;
                            classBatchSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching batches:', error);
                        classBatchSelect.innerHTML = '<option value="">Error loading batches</option>';
                    });
            } else {
                classBatchSelect.innerHTML = '<option value="">Select a Class Name first</option>';
            }
        }

        classNameSelect.addEventListener('change', updateBatches);

        // Initial population
        updateBatches();
    });
</script>
{% endblock %}